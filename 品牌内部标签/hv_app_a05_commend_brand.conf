sql="
insert overwrite table   app.a05_commend_brand    partition(datekey='${END_DATEKEY:0:7}') 
select  
       a.the_month                -- 月份
      ,a.projectguid              -- 项目guid
      ,a.projectname              -- 项目名称
      ,a.city                     -- 城市
      ,a.province                 -- 省份
      ,a.district_name            -- 片区名称
      ,a.companyguid              -- 公司guid
      ,a.companyname              -- 公司名称
      ,max(a.is_confilling) as is_confilling  --是否已归档
      ,max(a.is_yrent)      as is_yrent       --是否已出租 
      ,max(a.is_jprent)     as is_jprent      --是否已接铺
      ,max(a.is_openrent)   as is_openrent    --是否已开业
      ,a.brandid                             -- 品牌
      ,a.brand_name                          --品牌名称
      ,sum(a.totalarea)     as  totalarea   --合同面积
      ,case when  substr(min(a.open_date),1,10) <=  add_months(current_date,-12) 
                              and substr(max(a.close_date),1,10)>=current_date      
                               then datediff(current_date,add_months(current_date,-12))  
                         when   substr(min(a.open_date),1,10) <=  add_months(current_date,-12)      
                              and substr(max(a.close_date),1,10)<=current_date      
                              and substr(max(a.close_date),1,10) >= add_months(current_date,-12)                    
                               then datediff(max(a.close_date),add_months(current_date,-12)) 
                          when  substr(min(a.open_date),1,10) <=  add_months(current_date,-12)   
                                and  substr(max(a.close_date),1,10) <=  add_months(current_date,-12)  
                               then 0
                         when  substr(min(a.open_date),1,10) > add_months(current_date,-12)  
                               and substr(min(a.open_date),1,10)<=current_date    
                                and substr(max(a.close_date),1,10)>=current_date 
                                then datediff(current_date,min(a.open_date)) 
                         when  substr(min(a.open_date),1,10) > add_months(current_date,-12)
                                and substr(min(a.open_date),1,10) <= current_date          
                                and substr(max(a.close_date),1,10) < current_date                         
                                then datediff(max(a.close_date),min(a.open_date))                                                                   
                         when substr(min(a.open_date),1,10) > current_date 
                              then 0                      
                          else 0    
                          end           as    jyn_jyts
 --     ,sum(a.jyn_jyts)      as jyn_jyts    -- 近一年经营天数
      ,sum(a.amt_sum)       as amt_sum    -- 近一年营业额
      ,max(b.cust_num)           as customer    -- 近一年客流人数
      ,max(b.cust_days)           as customer_days    -- 近一年有客流天数
      ,sum(a.bd_income_y)   as bd_income_y    --含税保底 
      ,sum(a.taking_income_y) as taking_income_y  --含税抽成 
      ,sum(a.mng_income_y)    as mng_income_y  --含税物业 
      ,sum(a.tg_income_y)     as tg_income_y  --含税推广 
      ,sum(a.bd_income_n)     as bd_income_n  --不含税保底 
      ,sum(a.taking_income_n) as taking_income_n  --不含税抽成 
      ,sum(a.mng_income_n)    as mng_income_n  --不含税物业 
      ,sum(a.tg_income_n)     as tg_income_n  --不含税推广
      ,from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')       as op_time                   --时间戳
      ,'${EXECUTION_ID}'                                            as execution_id              --批次号
      ,'${CURRENT_FLOW_START_DAY}'                                  as load_date                 --入库时间
  
      from (
select   distinct 
      a.the_month                                            
     ,a.projectguid                                          
     ,a.projectname                                          
     ,a.city                                                 
     ,a.province                                             
     ,a.district_name                                        
     ,a.companyguid                                          
     ,a.companyname                                          
     ,a.is_confilling  --是否已归档                          
     ,a.is_yrent       --是否已出租                               
     ,a.is_jprent      --是否已接铺                              
     ,a.is_openrent    --是否已开业                            
     ,t.brandid                                              
     ,t.brand_name                                           
     ,a.totalarea/t.brand_num          as  totalarea        --合同面积           
--   ,a.op_days_y/t.brand_num          as  jyn_jyts         -- 近一年经营天数        
     ,a.amt_sum_y/t.brand_num          as  amt_sum          -- 近一年营业额         
     ,a.customer_y/t.brand_num         as  customer         -- 近一年客流人数
--   ,a.customer_days_y/t.brand_num    as  customer_days    -- 近一年有客流天数       
     ,a.bd_income/t.brand_num          as  bd_income_y      --含税保底            
     ,a.taking_income/t.brand_num      as  taking_income_y  --含税抽成            
     ,a.mng_income_y/t.brand_num       as  mng_income_y     --含税物业            
     ,a.tg_income/t.brand_num          as  tg_income_y      --含税推广            
     ,a.bd_income_n/t.brand_num        as  bd_income_n      --不含税保底           
     ,a.taking_income_n/t.brand_num    as  taking_income_n  --不含税抽成           
     ,a.mng_income_n_y/t.brand_num     as  mng_income_n     --不含税物业           
     ,a.tg_income_n/t.brand_num        as  tg_income_n      --不含税推广  
     ,a.close_date
     ,a.open_date         
     
from
${HIVE_DB_APP}.a05_commend_contract a
left join  (select   a.*,b.brand_name,b.format_id    from   --取合同对应的品牌数量
                     (select DISTINCT 
                      t.contractid
                     ,case when t2.newbrandid='-' then t2.brand_id else t2.newbrandid end    as brandid
                     ,sum(1) OVER (PARTITION by t.contractid)  as brand_num
                     FROM ${HIVE_DB_DWD_SYSMARTBI}.sysmartbi_rt_contract t
                     left join ${HIVE_DB_DWD_SYSMARTBI}.sysmartbi_rt_contractbrand t1 on t1.contractid = t.contractid
                     left join ${HIVE_DB_DIM}.d05_longfor_brand t2 
                     on  t2.brand_id = t1.brandid 
                     where t1.status = 'ACTIVE'
                     and t2.status <> 'INACTIVE')a
            left join ${HIVE_DB_DIM}.d05_longfor_brand b on a.brandid=b.brand_id
    ) t 
             on a.contractid=t.contractid                                   
                                   
where a.is_yrent='1'
and a.the_month>=substr(add_months('${START_DATEKEY}',-1),1,7)
and a.the_month<=substr(add_months('${END_DATEKEY}',-1),1,7)
) a
left join (select              --取客流人数以及有客流天数
         a.project_id
        ,a.brandid
        ,sum(a.insum)  as cust_num
        ,sum(case when a.insum>0 then 1 else 0 end ) as cust_days
      from (          select            
                                 a.project_id
                                ,sum(a.insum) as insum
                                ,b.brandid
                                ,b.brand_name
                                ,a.biz_date
                         from  (select substr(biz_date,1,10) as  biz_date
                                        ,project_id
                                        ,contract_no
                                        ,contract_id
                                        ,sum(insum) as  insum
                                 from ${HIVE_DB_DWS}.f05_day_statistics
                                 group by  substr(biz_date,1,10)
                                           ,project_id
                                           ,contract_no
                                           ,contract_id
                                 ) a
                         left join (select   a.*,b.brand_name    from 
                                       (select DISTINCT 
                                          t.contractid
                                         ,case when t2.newbrandid='-' then t2.brand_id else t2.newbrandid end    as brandid
                                         FROM ${HIVE_DB_DWD_SYSMARTBI}.sysmartbi_rt_contract t
                                         left join ${HIVE_DB_DWD_SYSMARTBI}.sysmartbi_rt_contractbrand t1 on t1.contractid = t.contractid
                                         left join ${HIVE_DB_DIM}.d05_longfor_brand t2 
                                         on  t2.brand_id = t1.brandid 
                                         where t1.status = 'ACTIVE'
                                         and t2.status <> 'INACTIVE')a
                                            left join ${HIVE_DB_DIM}.d05_longfor_brand b on a.brandid=b.brand_id
                                     ) b       
                         on a.contract_id = b.contractid
                         where substr(a.biz_date,1,10)>=add_months(current_date,-12)
                         group by    
                                 a.project_id
                                ,b.brandid
                                ,b.brand_name
                                ,a.biz_date
                         ) a 
                          
                         group by 
                           
                            a.project_id
                           ,a.brandid
                          
              
                         )b
on a.brandid=b.brandid
and a.projectguid=b.project_id

group by 
          a.the_month    
         ,a.projectguid  
         ,a.projectname  
         ,a.city         
         ,a.province     
         ,a.district_name
         ,a.companyguid  
         ,a.companyname  
         ,a.brandid    
         ,a.brand_name
"
task_incre_type=multi-day
