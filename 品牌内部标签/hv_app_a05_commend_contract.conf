 sql="
 insert overwrite table   app.a05_commend_contract    partition(datekey='${END_DATEKEY:0:7}')
 select   a.the_month                -- as       '日期'   
         ,a.contractno              -- as       '合同编号'
         ,a.contractid              -- as       '合同ID'      
         ,b.district_name           -- as       '片区名称'   
         ,b.province                -- as       '省份'   
         ,b.city                    -- as       '城市'   
         ,a.projectguid             -- as       '项目guid'   
         ,b.projectname             -- as       '项目名称'   
         ,b.companyguid             -- as       '地区guid'   
         ,b.companyname             -- as       '地区名称'   
         ,max(c.defaultstartdate)   -- as       '约定接铺时间'   
         ,max(c.willopendate)       -- as       '约定开业时间'   
         ,max(c.defaultexpirydate)  -- as       '约定收铺时间'   
         ,max(c.overlay_date)       -- as       '实际接铺时间'   
         ,max(c.open_date)          -- as       '实际开业时间'   
         ,max(c.close_date)         -- as       '实际收铺时间'   
         ,max(c.filing_date)        -- as       '归档时间'   
         ,max(a.is_confilling)      -- as       '是否已归档'   
         ,max(a.is_yrent)           -- as       '是否已出租'   
         ,max(a.is_jprent)          -- as       '是否已接铺'   
         ,max(a.is_openrent)        -- as       '是否已开业'   
         ,max(is_end)               -- as       '是否已收铺'   
         ,sum(case when a.taking_income_y is not null and a.taking_income_y<>0                   
                then 1 else 0 end)   -- as       '已收抽成租金次数'   
         ,concat_ws('、',collect_set(h.build_id))              -- as       '楼栋'
         ,concat_ws('、',collect_set(h.build_name))            -- as       '楼栋名称'
         ,concat_ws('、',collect_set(h.floor_id))              -- as       '楼层编号'
         ,concat_ws('、',collect_set(h.floor_name))            -- as        '楼层'  
         ,max(f.turnoverregulation)       --  as       'POS使用'   
         ,max(c.SIGNTYPE)                 --  as       '合同条款'   
         ,max(c.rentcal_mode)             --  as       '租金模式'   
         ,max(a.m_ccblmode)               --  as       '抽成方式'   
         ,max(a.totalarea)                --  as       '合同面积'   
         ,null                            --  as       '是否集团品牌' 
         ,max(c.rentcal_mode)             --  as        '合作模式'   
         ,max(c.jyn_jyts)                 --  as       '近一年经营天数'   
         ,max(d.customer_days)            --  as       '近一年有客流天数'   
         ,max(case when a.is_jprent='1' then  g.amt_sum else 0 end)       --  as       '近一年营业额'   
         ,max(d.customer)                 --  as       '近一年客流总人数'   
         ,max(e.bd_income_y)              --  as       '近一年含税保底租金'   
         ,max(e.taking_income_y)          --  as       '近一年含税抽成租金'   
         ,max(e.mng_income_y)             --  as       '近一年含税物业管理费'   
         ,max(e.tg_income_y)              --  as       '近一年含税推广服务费'
         ,max(e.bd_income_n)              --  as       '近一年不含税保底租金' 
         ,max(e.taking_income_n)          --  as       '近一年不含税抽成租金' 
         ,max(e.mng_income_n)             --  as       '近一年不含税物业管理费'
         ,max(e.tg_income_n)              --  as       '近一年不含税推广服务费'   
         ,max(a.mng_income_y)             --  as       '当月含税物业费'
         ,max(a.mng_income_n)             --  as   '当月不含税物业费'   
         ,min(a.revenueratemin)           --  as       '最低扣率'   
         ,max(a.revenueratemax)           --  as       '最高扣率'
         ,from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss')       as op_time                   --时间戳
         ,'${EXECUTION_ID}'                                            as execution_id              --批次号
         ,'${CURRENT_FLOW_START_DAY}'                                  as load_date                 --入库时间
   
         
from
 ${HIVE_DB_DWS}.f05_month_contract a      
                                                           
left join ${HIVE_DB_DIM}.pub_longfor_project_temp_sysmartbi b   
           on a.projectguid=b.projectguid 
              
left join ( select       project_guid     --取近一年经营天数                                
                        ,contract_no
                        ,case when  substr(b.open_date,1,10) <=  add_months(current_date,-12) 
                              and substr(b.close_date,1,10)>=current_date      
                               then datediff(current_date,add_months(current_date,-12))  -- 一直在开业 
                         when   substr(b.open_date,1,10) <=  add_months(current_date,-12)      
                              and substr(b.close_date,1,10)<=current_date      
                              and substr(b.close_date,1,10) >= add_months(current_date,-12)                    
                               then datediff(b.close_date,add_months(current_date,-12))  -- 现在关门
                          when  substr(b.open_date,1,10) <=  add_months(current_date,-12)   
                                and  substr(b.close_date,1,10) <=  add_months(current_date,-12)  
                               then 0
                         when  substr(b.open_date,1,10) > add_months(current_date,-12)  
                               and substr(b.open_date,1,10)<=current_date    
                                and substr(b.close_date,1,10)>=current_date 
                                then datediff(current_date,b.open_date) 
                         when  substr(b.open_date,1,10) > add_months(current_date,-12)
                                and substr(b.open_date,1,10) <= current_date          
                                and substr(b.close_date,1,10) < current_date                         
                                then datediff(b.close_date,b.open_date)                                                                   
                         when substr(b.open_date,1,10) > current_date 
                              then 0                      
                          else 0    
                          end       as  jyn_jyts
                   ,b.defaultstartdate  as defaultstartdate 
                   ,b.willopendate      as willopendate     
                   ,b.defaultexpirydate as defaultexpirydate
                   ,b.overlay_date      as overlay_date     
                   ,b.open_date         as open_date        
                   ,b.close_date        as close_date       
                   ,b.filing_date       as filing_date      
                   ,b.SIGNTYPE           as SIGNTYPE
                   ,b.rentcal_mode           as rentcal_mode 
             from  ${HIVE_DB_DIM}.d05_longfor_contract b
              )  c 
                          
              on   c.project_guid=a.projectguid
                  and c.contract_no=a.contractno

left join (select             --取近一年客流
                                 project_id
                                ,contract_no
                                ,sum(insum) as customer
                                ,sum(case when insum>0 then 1 else 0 end ) customer_days 
                         from  (select substr(biz_date,1,10) as  biz_date
                                        ,project_id
                                        ,contract_no
                                        ,sum(insum) as  insum
                                 from ${HIVE_DB_DWS}.f05_day_statistics
                                 group by  substr(biz_date,1,10)
                                           ,project_id
                                           ,contract_no
                                 ) a
                         where substr(biz_date,1,10)>=add_months(current_date,-12) 
                         group by  
                                   project_id
                                   ,contract_no  ) d
                     on a.contractno=d.contract_no
                     and a.projectguid=d.project_id
left join (select  projectguid       -- 取近一年4项含税与不含税
                     ,contractno
                   ,sum(bd_income_y)         as bd_income_y
                   ,sum(taking_income_y)     as taking_income_y
                   ,sum(mng_income_y)        as mng_income_y
                   ,sum(tg_income_y)         as tg_income_y
                   ,sum(bd_income_n)         as bd_income_n
                   ,sum(taking_income_n)     as taking_income_n
                   ,sum(mng_income_n)        as mng_income_n
                   ,sum(tg_income_n)         as tg_income_n
            from  ${HIVE_DB_DWS}.f05_month_contract
            where the_month>=substr(add_months(current_date,-12),1,7) 
            group by  
                    projectguid
                    ,contractno)e                                      
            on a.contractno=e.contractno
               and a.projectguid=e.projectguid                                            
left join ${HIVE_DB_DWD_SYSMARTBI}.sysmartbi_rt_contract  f
           on f.contractno=a.contractno
           and f.projectid=a.projectguid     
left join (select                     -- 取近一年营业额
                                a.projectguid
                                ,a.contractno
                                ,sum(a.saleamt) as amt_sum
                                ,sum(a.salenum) as num_sum
                         from ${HIVE_DB_DWS}.f05_longfor_saledata a
                         left join ${HIVE_DB_DWS}.f05_contract b
                               on substr(a.the_date,1,7)=substr(b.the_date,1,7) 
                               and  a.contractno=b.contractno
                               and  a.projectguid=b.projectguid
                         where b.rentaltype in ('Main','SingleCabinet','Site','SubAnchor','Exclusive')
                               and substr(a.the_date,1,10)>=add_months(current_date,-12)
                         group by 
                                   a.projectguid 
                                  ,a.contractno
                                  ) g  
             on g.projectguid=a.projectguid
             and g.contractno=a.contractno  
left join ${HIVE_DB_DWS}.f05_month_unit h                                                      
               on  h.contractid=a.contractid 
               and a.the_month=h.the_month            
where a.the_month>=substr(add_months('${START_DATEKEY}',-1),1,7)
 and a.the_month<=substr(add_months('${END_DATEKEY}',-1),1,7)                  
group by 
 
        a.the_month         
       ,a.contractno           
       ,a.contractid     
       ,b.district_name    
       ,b.province         
       ,b.city            
       ,a.projectguid 
       ,b.projectname  
       ,b.companyguid 
        ,b.companyname
"
task_incre_type=multi-day