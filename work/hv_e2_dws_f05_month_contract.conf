sql="
-- 修改日期：
-- 版本号：
-- 修改人：张朋飞
-- 变更内容:蒜头经分会需求：修改租金、收入取值方式


use dws;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.max.dynamic.partitions=100000;
set hive.exec.max.dynamic.partitions.pernode=100000;
set hive.exec.parallel=true;
set hive.exec.parallel.thread.number=8;
with date as (
select
the_month
,case when  the_month=substr('${END_DATEKEY}',1,7) and   cast(substr('${END_DATEKEY}',9,2) as int)<>1  then  date_sub('${END_DATEKEY}',1)
else   last_day_of_month  end  as last_day_of_month
from  dim.pub_longfor_month
where (the_month<=substr(date_sub('${END_DATEKEY}',1),1,7)
and the_month>=substr(add_months('${START_DATEKEY}',-1),1,7)   )
)
insert overwrite table ${HIVE_DB_DWS}.f05_month_contract  partition (datekey)
select
 a.the_month
,a.projectguid
,a.companyguid
,a.contractid
,a.contractno
,a.mainformatid
,a.branddesc
,a.accountid
,a.accountname
,a.contracttype
,a.contracttypedesc
,a.rentaltype
,a.topparentid
,a.parentid
,a.sign_type
,a.is_start
,a.is_end
,a.issk
,a.is_yrent
,a.is_openrent
,a.is_jprent
,a.is_confilling
,a.is_confilling_receipt
,a.is_runtime
,a.totalarea
,a.lqtotalarea
,a.bdamt_y
,a.ccamt_y
,a.wgamt_y
,a.tgamt_y
,a.syamt_y
,a.bdamt_n
,a.ccamt_n
,a.wgamt_n
,a.tgamt_n
,a.syamt_n
,a.lqbdamt_y
,a.lqccamt_y
,a.lqwgamt_y
,a.lqtgamt_y
,a.lqsyamt_y
,a.lqbdamt_n
,a.lqccamt_n
,a.lqwgamt_n
,a.lqtgamt_n
,a.lqsyamt_n

,a.bd_income_y
,a.taking_income_y
,a.mng_income_y
,a.tg_income_y
,a.bd_income_n
,a.taking_income_n
,a.mng_income_n
,a.tg_income_n
,a.m_ccblmode
,a.revenueratemin
,a.revenueratemax
,a.bg_jparea
,b.bgrent_amt
,b.bgmng_amt
,b.bgpromotion_amt
,b.bgfmr_amt
,b.bgrevenue_amt
,b.rentamt
,b.takingamt
,b.mngamt
,b.promotionamt
,b.fmramt
,b.unit_fmr
,b.unit_num
,from_unixtime(unix_timestamp(), 'yyyy-MM-dd HH:mm:ss') as op_time
,'${EXECUTION_ID}' as execution_id
,'${CURRENT_FLOW_START_DAY}' as load_date
,substr(a.the_month,1,7)  as datekey
from(

select 
a.the_month 
 ,a.projectguid
 ,a.companyguid
 ,a.contractid
 ,a.contractno
 ,a.mainformatid
 ,a.branddesc
 ,a.accountid
 ,a.accountname
 ,a.contracttype
 ,a.contracttypedesc
 ,a.rentaltype
 ,a.topparentid
 ,a.parentid
 ,a.sign_type
 ,a.is_start
 ,a.is_end
 ,a.issk
 ,a.is_yrent
 ,a.is_openrent
 ,a.is_jprent
 ,a.is_confilling
 ,a.is_confilling_receipt
 ,a.is_run as is_runtime
 ,a.totalarea
 ,a.lqtotalarea
 ,a.lqbdamt_y
 ,a.lqccamt_y
 ,a.lqwgamt_y
 ,a.lqtgamt_y
 ,a.lqsyamt_y
 ,a.lqbdamt_n
 ,a.lqccamt_n
 ,a.lqwgamt_n
 ,a.lqtgamt_n
 ,a.lqsyamt_n
 ,a.m_ccblmode
 ,a.revenueratemin
 ,a.revenueratemax
 ,a.bg_jparea
  ,b.bdamt_y
  ,b.ccamt_y
  ,b.wgamt_y
  ,b.tgamt_y
  ,b.syamt_y
  ,b.bdamt_n
  ,b.ccamt_n
  ,b.wgamt_n
  ,b.tgamt_n
  ,b.syamt_n
 ,b.bd_income_y   
 ,b.taking_income_y
 ,b.mng_income_y
 ,b.tg_income_y
 ,b.bd_income_n
 ,b.taking_income_n
 ,b.mng_income_n
 ,b.tg_income_n
 
from(
select 
   substr(the_date,1,7) as the_month
  ,a.projectguid
  ,a.companyguid
  ,a.contractid
  ,a.contractno
  ,a.mainformatid
  ,a.branddesc
  ,a.accountid
  ,a.accountname
  ,a.contracttype
  ,a.contracttypedesc
  ,a.rentaltype
  ,a.topparentid
  ,a.parentid
  ,a.sign_type
  ,a.is_start
  ,a.is_end
  ,a.issk
  ,a.is_yrent
  ,a.is_openrent
  ,a.is_jprent
  ,a.is_confilling
  ,a.is_confilling_receipt
  ,a.is_run 
  ,a.totalarea
  ,a.lqtotalarea
  ,a.lqbdamt_y
  ,a.lqccamt_y
  ,a.lqwgamt_y
  ,a.lqtgamt_y
  ,a.lqsyamt_y
  ,a.lqbdamt_n
  ,a.lqccamt_n
  ,a.lqwgamt_n
  ,a.lqtgamt_n
  ,a.lqsyamt_n
  ,a.m_ccblmode
  ,a.revenueratemin
  ,a.revenueratemax
  ,a.bg_jparea
from   ${HIVE_DB_DWS}.f05_contract a 
inner join  date b
on a.the_date=b.last_day_of_month
)a 
left join (select 
b.the_month
,a.projectguid 
,a.contractno 
, sum(a.bdamt_y)  AS bdamt_y
, sum(a.ccamt_y)  AS ccamt_y
, sum(a.wgamt_y)  AS wgamt_y
, sum(a.tgamt_y)  AS tgamt_y
, sum(a.syamt_y)  AS syamt_y
, sum(a.bdamt_n)  AS bdamt_n
, sum(a.ccamt_n)  AS ccamt_n
, sum(a.wgamt_n)  AS wgamt_n
, sum(a.tgamt_n) AS  tgamt_n
, sum(a.syamt_n)  AS syamt_n
,sum(a.bd_income_y) AS      bd_income_y   
,sum(a.taking_income_y) AS  taking_income_y
,sum(a.mng_income_y)    AS  mng_income_y
,sum(a.tg_income_y)     AS  tg_income_y
,sum(a.bd_income_n)      AS bd_income_n
,sum(a.taking_income_n) AS  taking_income_n
,sum(a.mng_income_n)     AS mng_income_n
,sum(a.tg_income_n)      AS tg_income_n
from ${HIVE_DB_DWS}.f05_contract  a 
inner join date b  ON substr(a.the_date,1,7)=b.the_month 
group by b.the_month
,a.projectguid
,a.contractno )b 
on a.the_month=b.the_month 
and a.projectguid =b.projectguid
and a.contractno=b.contractno
)a
  left join(select
   the_month
  ,contractno
  ,projectguid
,SUM(bgrent_amt)  as bgrent_amt
,SUM(bgmng_amt)    as bgmng_amt
,SUM(bgpromotion_amt)  as bgpromotion_amt
,SUM(bgfmr_amt)   as bgfmr_amt
,SUM(bgrevenue_amt)  as bgrevenue_amt
,SUM(rentamt)      as rentamt
,SUM(takingamt)    as takingamt
,SUM(mngamt)        as mngamt
,SUM(promotionamt)  as promotionamt
,SUM(fmramt)    as fmramt
,SUM(unit_fmr)  as unit_fmr
,count(1) as unit_num
from  ${HIVE_DB_DWS}.f05_month_unit
where the_month<=substr('${END_DATEKEY}',1,7)
and the_month>=substr(add_months('${START_DATEKEY}',-1),1,7)
group by the_month
,contractno
,projectguid
) b
  on a.the_month=b.the_month
and a.contractno=b.contractno
and a.projectguid=b.projectguid
;
"
task_incre_type=multi-day
